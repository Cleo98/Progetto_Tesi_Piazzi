<html>
	<head>
		<meta charset="UTF-8">
		<title>Character's App</title>
		<script language="javascript" type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script type="text/javascript">
     /*window.addEventListener('load', async() => {
      if (window.ethereum) {
        window.web3 = new Web3(ethereum);
        try {
            // Request account access if needed
            console.log("window.ethereum");
            ethereum.enable();
        } catch (error) {
            // User denied account access...
        }
    }
    // Legacy dapp browsers...
    else if (window.web3) {
        window.web3 = new Web3(web3.currentProvider);
        console.log("window.currentProvider");
        // Acccounts always exposed

    }
    // Non-dapp browsers...
    else {
        console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
    }
     })*/
      //foam bachelor aisle humor latin assault draw liberty junk arrive destroy forget 
    </script>
    <script language="javascript" type="text/javascript" src=".\TruffleProject\application\Abis.js"></script>
    <script language="javascript" type="text/javascript" src=".\TruffleProject\node_modules\web3\dist\web3.min.js"></script>
	</head>
<body>
  <script>
    var web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:7545")); 
    var userAccount;
    var characters;
    var breeding;

    window.addEventListener('load', async() => {
        if(typeof(web3) !== 'undefined') {
          web3 = new Web3(web3.currentProvider);
          console.log("Metamask is installed");
          startApp();
        }else {
          console.log("Can't find Metamask");
        }
      }) 

    
    function startApp(){
      const addressCharacters = ""; //contract address
      characters = new web3.eth.Contract(abiCharacters, addressCharacters);
      console.log(characters);
      breeding = new web3.eth.Contract(abiBreeding, "");
      console.log(breeding);

      userAccount = ""; 

    $(document).ready(function() {
      $("button.generate").click(async() => {
        var name = $("#name").val(); 
        try{
          await characters.methods.createRandomCharacter(name).send({from: userAccount, value: 5000000000000000, gas: 300000}); 
        }catch{
          alert("Hai già due personaggi! Per produrne di nuovi devi usare la sezione di breeding");
        }
        //alert(name); 
        getCharactersByOwner(userAccount)
            .then(displayCharacters);
        console.log(await characters.methods.characterToOwner(1).call({from: userAccount})); //Questo viene letto correttamente
        console.log(await breeding.methods.characterToOwner(1).call({from: userAccount})); //Questo è undefined oppure nullo
        characters.getPastEvents(
          'NewCharacter', {
            fromBlock: 0, 
            toBlock: 'latest'
          }, (err, events) => { 
            console.log(events) } ) }) 

      $("button.breed").click(async() => {
        var campi = $(".breedField");
        var firstId = campi.eq(0).val();
        var secondId = campi.eq(1).val();
        var name = campi.eq(2).val();
       
        try{
          await breeding.methods.crossBreeding(Number(firstId), Number(secondId), name).send({from: userAccount});
        }catch{ //da sempre errore perchè non riesce a leggere characterToOwner 
          alert("Spero tu stia usando i tuoi personaggi... ma ricordati che devono essere pronti");
        }
      }) })
    
  }  

      function getCharactersByOwner(owner) {
        return characters.methods.getCharactersByOwner(owner).call();
      }

      function getCharacterDetails(id) {
        return characters.methods.book(id).call();
      }

      function displayCharacters(ids) {
        $("#charactersList").empty();
        for (id of ids) {
          getCharacterDetails(id)
          .then(function(character) {
            $("#charactersList").append(`<div class="character">
              <ul>
                <li>Name: ${character.name}</li>
                <li>Id: ${character.id}</li>
                <li>Ready Time: ${character.readyTime}</li>
                <li>Xp: ${character.xp}</li>
                <li>Rarity: ${character.rarity}</li>
                <li>Level: ${character.level}</li>
              </ul>
            </div>`);
          });
        }
      }
  </script>

    Non hai ancora due personaggi? Clicca qui per generarne uno nuovo e iniziare a giocare!
		<form>
      <label>Name: <input type="text" id="name"></label> 
      <button type="button" class="generate">Genera personaggio</button>
    </form>	

    I tuoi personaggi:
    <div id="charactersList"></div>

    <script type="text/javascript">
      
    </script>

    Breeding section
    <form>
      <label>First Character's id: <input type="text" class="breedField"></label>
      <label>Second Character's id: <input type="text" class="breedField"></label>
      <label>Nome del nuovo personaggio: <input type="text" class="breedField"></label> 
      <button type="button" class="breed">Breed</button>
    </form>

    Minigames section
    Classic
    <form>
      <label>Character's id: <input type="text" id="player"></label>
      <label>Minigame: </label>
      <select>
        <option>SumDice</option>
        <option>FightDice</option>
        <option>Pari o dispari?</option>
        <option>Higher or lower?</option>
      </select>
      <button type="button" class="play">Gioca</button>
    </form>
    Emergency
    Give Away

    Vuoi far evolvere il tuo personaggio?
    <form>
      <input type="submit" value="Alla sezione Laboratorio">
    </form>

    Devi scambiare un personaggio?
    <form>
      <input type="submit" value="Alla sezione Exchange">
    </form>

	</body> 
</html>
